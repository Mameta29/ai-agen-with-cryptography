version: '3.8'

services:
  # メインアプリケーション
  ai-gmail-automation:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - USE_LOCAL_AI=true
      - LOCAL_AI_URL=http://localhost:11434
      - FALLBACK_TO_OPENAI=false
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      - ollama
    command: >
      sh -c "
        echo '🚀 Actually Intelligent デモ環境を起動中...' &&
        pnpm install &&
        echo '✅ 依存関係インストール完了' &&
        echo '🧠 ローカルAIシステム準備完了' &&
        echo '🔐 zkVMシステム準備完了' &&
        echo '🎯 ハッカソンデモ準備完了！' &&
        echo '' &&
        echo '📋 利用可能なコマンド:' &&
        echo '  - pnpm dev: 開発サーバー起動' &&
        echo '  - node demo-hackathon-ready.js: ハッカソンデモ実行' &&
        echo '  - ./verify.sh: システム検証' &&
        echo '' &&
        tail -f /dev/null
      "

  # Ollama（ローカルAI）
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  ollama_data: 